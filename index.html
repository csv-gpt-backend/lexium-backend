<!DOCTYPE html> 
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lexium V1 Sudam√©rica</title>
<style>
  :root{
    --bg:#fff; --fg:#111; --muted:#6b7280; --pri:#0d6efd; --bd:#e5e7eb;
    --ok:#16a34a; --err:#b91c1c;
    --heroH: 65vh;
    --wrapW: 1180px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;}

  .mediaBar{
    position:fixed; top:0; left:0; width:100vw; z-index:50;
    background:#fff; border-bottom:none; padding:0; margin:0;
    pointer-events:none;
  }
  .mediaBar *{ pointer-events:none; }
  .mediaInner{max-width:var(--wrapW); margin:0 auto; padding:12px;}
  .heroGrid{display:grid; grid-template-columns:1fr 3fr 1.16fr; align-items:center; gap:8px;}
  .sideImg{display:flex; justify-content:center; height:var(--heroH); margin:0;}
  .sideImg img{max-width:100%; height:100%; object-fit:contain; opacity:.95}
  .videoBox{height:var(--heroH); margin:0;}
  .videoBox video{width:100%; height:100%; object-fit:cover; border:none; display:block; border-radius:10px}

  .contentWrap{
    max-width:var(--wrapW); margin:0 auto; padding:12px;
    /* subo un poco para que NO lo tape el video */
    padding-top:calc(var(--heroH) + 24px);
  }

  .toolbar{display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:8px 0}
  .toolbar button, .toolbar select{padding:9px 14px; border:1px solid var(--bd); border-radius:10px; background:#fff; cursor:pointer;}
  .toolbar button:hover{background:#f5f7fb}
  .toolbar button[disabled]{opacity:.6; cursor:not-allowed}

  .hist{position:fixed; right:14px; top:10px; z-index:60}
  .hist button{padding:8px 12px; border:1px solid var(--bd); border-radius:10px; background:#fff}

  /* Caja de texto: 2 l√≠neas fijas */
  .query{
    width:100%;
    box-sizing:border-box;
    height:64px; min-height:64px; max-height:64px; /* ‚Üê 2 l√≠neas */
    margin-top:6px;
    resize:none; overflow:auto;
    border:1px solid var(--bd); border-radius:10px;
    padding:8px 12px; font-size:16px; line-height:1.4;
  }

  .out{margin:8px 0; border:1px solid var(--bd); border-radius:12px; padding:12px; overflow:auto; white-space:pre-wrap; max-height:65vh;}
  .muted{color:var(--muted); font-size:.9rem}

  table{width:100%; border-collapse:collapse; margin:10px 0}
  th,td{border:1px solid var(--bd); padding:8px}
  th{background:#f8fafc; text-align:left}

  .loader{display:inline-flex; align-items:center; gap:8px; font-size:.95rem; color:var(--muted)}
  .dot{width:8px; height:8px; border-radius:50%; background:var(--pri); opacity:.7; animation:bounce 1s infinite}
  .dot:nth-child(2){animation-delay:.15s}
  .dot:nth-child(3){animation-delay:.3s}
  @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

  /* Overlay Historial */
  .overlay{
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.25);
    z-index:80; align-items:center; justify-content:center; padding:24px;
  }
  .overlay.show{ display:flex; }
  .panel{
    background:#fff; border:1px solid var(--bd); border-radius:12px;
    width:min(1000px, 94vw); max-height:84vh; overflow:hidden; display:flex; flex-direction:column;
  }
  .panel header{display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--bd)}
  .panel h2{margin:0; font-size:18px}
  .closeBtn, .backBtn{border:1px solid var(--bd); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer}
  .panelBody{padding:12px 16px; overflow:auto}
  .session{border-top:1px solid var(--bd); padding:10px 0; display:flex; align-items:center; gap:10px}
  .session .meta{flex:1}
  .viewBtn{border:1px solid var(--bd); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer}

  /* Vista detalle historial */
  #histDetailView{display:none;}
  .histQuestion{margin:0 0 8px 0}
  .histTools{display:flex; gap:8px; margin:8px 0 10px}
  .histContent{border:1px solid var(--bd); border-radius:10px; padding:12px; overflow:auto}

  /* Badge superior izq para ‚ÄúConsultando‚Ä¶‚Äù */
  .statusTop{
    position:fixed; top:10px; left:10px; z-index:70;
    background:#fff; border:1px solid var(--bd); border-radius:10px;
    padding:6px 10px; display:none;
  }
  .statusTop.show{ display:block; }
</style>
</head>
<body>

  <div class="hist">
    <button id="btnHist" title="Ver sesiones guardadas">Biblioteca</button>
  </div>

  <!-- √öNICO indicador de estado (esquina sup-izq) -->
  <div id="statusTop" class="statusTop" aria-live="polite"></div>

  <div class="mediaBar" aria-label="cabecera">
    <div class="mediaInner">
      <div class="heroGrid">
        <div class="sideImg left">
          <img src="left.png" alt="Logo izquierdo"/>
        </div>
        <div class="videoBox">
          <video id="vid" preload="auto" muted playsinline src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4"></video>
        </div>
        <div class="sideImg right">
          <img src="right.png" alt="Logo derecho"/>
        </div>
      </div>
    </div>
  </div>

  <div class="contentWrap">
    <div style="margin:10px 0 6px">
      <!-- 2 l√≠neas fijas -->
      <textarea id="q" class="query" rows="2" placeholder="ESCRIBE O HABLA PARA PREGUNTAR...."></textarea>
    </div>

    <div class="toolbar">
      <button id="btnSend" title="Enviar consulta al backend">Enviar</button>
      <button id="btnCancel" title="Cancelar consulta en curso" disabled>‚úñ Cancelar</button>
      <button id="btnDict" title="Dictar por voz (empieza / detiene)">üé§ Dictar</button>
      <button id="btnToggleAV" title="Parar/Activar voz">‚èØ Detener Voz</button>
      <button id="btnReplay" title="Reproducir nuevamente la voz desde el principio">‚ü≥ Reproducir Nuevamente</button>
      <button id="btnNew" title="Nueva sesi√≥n (limpia y guarda la actual)">Ôºã Nueva sesi√≥n</button>
      <button id="btnClear" title="Limpiar pregunta y respuesta">üßπ Limpiar</button>
      <select id="selExport" title="Exportar lo generado">
        <option value="">Exportar‚Ä¶</option>
        <option value="pdf">PDF (vista previa)</option>
        <option value="csv">CSV</option>
        <option value="doc">DOC</option>
      </select>
    </div>

    <div id="out" class="out" aria-live="polite"></div>
    <!-- status inferior oculto -->
    <div id="status" class="muted" style="display:none"></div>
  </div>

  <!-- Overlay Historial -->
  <div id="histOverlay" class="overlay" aria-modal="true" role="dialog">
    <div class="panel">
      <header>
        <h2>Sesiones</h2>
        <div style="display:flex; gap:8px">
          <button class="backBtn" id="backHist" style="display:none">‚Üê Volver</button>
          <button class="closeBtn" id="closeHist">Cerrar</button>
        </div>
      </header>
      <div class="panelBody">
        <div id="histListView"><div id="histBody"></div></div>
        <div id="histDetailView">
          <h3 class="histQuestion"></h3>
          <!-- NUEVO: herramientas de exportaci√≥n dentro de ‚ÄúVer‚Äù -->
          <div class="histTools" id="histTools" style="display:none">
            <button id="histPdfBtn"   title="Exportar esta vista a PDF">PDF</button>
            <button id="histCsvBtn"   title="Exportar esta vista a CSV">CSV</button>
            <button id="histDocBtn"   title="Exportar esta vista a DOC">DOC</button>
          </div>
          <div class="histContent" id="histContent"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://lexium-gpt5-383217514425.southamerica-west1.run.app";
const GPT_PATH = "/api/gpt";
const FALLBACK_PATH = "/api/answer";

/* ====== UI refs ====== */
const q = document.getElementById("q");
const out = document.getElementById("out");
const statusTop = document.getElementById("statusTop");
const vid = document.getElementById("vid");
const btnSend = document.getElementById("btnSend");
const btnCancel = document.getElementById("btnCancel");
const btnDict = document.getElementById("btnDict");
const btnToggleAV = document.getElementById("btnToggleAV");
const btnReplay = document.getElementById("btnReplay");
const btnNew = document.getElementById("btnNew");
const btnClear = document.getElementById("btnClear");
const selExport = document.getElementById("selExport");
const btnHist = document.getElementById("btnHist");
const histOverlay = document.getElementById("histOverlay");
const histBody = document.getElementById("histBody");
const closeHist = document.getElementById("closeHist");
const backHist = document.getElementById("backHist");
const histListView = document.getElementById("histListView");
const histDetailView = document.getElementById("histDetailView");
const histQuestion = document.querySelector(".histQuestion");
const histContent = document.getElementById("histContent");
const histTools = document.getElementById("histTools");
const histPdfBtn = document.getElementById("histPdfBtn");
const histCsvBtn = document.getElementById("histCsvBtn");
const histDocBtn = document.getElementById("histDocBtn");

/* ====== Estado ====== */
let isBusy = false;
let inFlightController = null;
let historyTurns = []; // [{role:"user"|"assistant", content:"texto"}]
const HS_KEY = "lexium_sess_history_v1";

/* Cargar historial de la pesta√±a */
try{
  const h = JSON.parse(sessionStorage.getItem(HS_KEY) || "[]");
  if (Array.isArray(h)) historyTurns = h;
}catch{}

/* ====== Utils ====== */
function esc(x){ return String(x).replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }
function setStatusLoading(msg="Generando‚Ä¶"){
  const html = `<span class="loader" role="status" aria-busy="true" aria-live="polite">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>${esc(msg)}
    </span>`;
  statusTop.innerHTML = html;
  statusTop.classList.add("show");
}
function clearStatus(){
  statusTop.textContent = "";
  statusTop.classList.remove("show");
}

/* ‚Äî Limpia frases de descargo si aparecen ‚Äî */
function stripDisclaimers(txt){
  if(!txt) return txt;
  const re = /(no\s+constituye\s+un\s+diagn[o√≥]stico\s+cl[i√≠]nico\s+ni\s+psicol[o√≥]gico.*)$/gmi;
  return txt.replace(re, "").replace(/\n{3,}/g, "\n\n").trim();
}

/* ====== Historial (overlay) ====== */
const SESS_KEY="lexium_sessions";
function saveSession(question, _data){
  const visible = (document.getElementById('out')?.innerHTML || "").trim();
  const entry = { id:new Date().toISOString(), question:question||"(sin pregunta)", html:visible, when:Date.now() };
  try{
    const all=JSON.parse(localStorage.getItem(SESS_KEY)||"[]");
    all.unshift(entry);
    localStorage.setItem(SESS_KEY, JSON.stringify(all.slice(0,50)));
  }catch(_){}
}
function readSessions(){ try{ return JSON.parse(localStorage.getItem(SESS_KEY)||"[]"); }catch(_){ return []; } }
function renderHistoryList(){
  const all=readSessions();
  histBody.innerHTML = all.length
    ? all.map(s=>`
      <div class="session">
        <div class="meta"><b>${new Date(s.when).toLocaleString()}</b><div><i>Pregunta:</i> ${esc(s.question)}</div></div>
        <button class="viewBtn" data-id="${esc(s.id)}">Ver</button>
      </div>`).join("")
    : "<p class='muted'>Sin historial.</p>";
}
function openHistory(){ histListView.style.display="block"; histDetailView.style.display="none"; backHist.style.display="none"; renderHistoryList(); histOverlay.classList.add("show"); }
function closeHistoryOverlay(){ histOverlay.classList.remove("show"); }
btnHist.addEventListener("click", openHistory);
closeHist.addEventListener("click", closeHistoryOverlay);
histOverlay.addEventListener("click",(e)=>{ if(e.target===histOverlay) closeHistoryOverlay(); });
backHist.addEventListener("click", ()=>{ histListView.style.display="block"; histDetailView.style.display="none"; backHist.style.display="none"; });
histBody.addEventListener("click",(e)=>{
  const btn = e.target.closest(".viewBtn"); if(!btn) return;
  const id = btn.getAttribute("data-id");
  const match = readSessions().find(x=>x.id===id);
  if(match){
    histQuestion.textContent = `Pregunta: ${match.question}`;
    histContent.innerHTML = match.html || "<em>Vac√≠o</em>";
    histListView.style.display="none"; 
    histDetailView.style.display="block"; 
    backHist.style.display="inline-block";
    histTools.style.display="flex"; // mostrar botones de exportar
  }
});

/* ====== Dictado ====== */
let recognizer=null;
function toggleDict(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert("Dictado no soportado en este navegador."); return; }
  if(!recognizer){
    recognizer=new SR(); recognizer.lang="es-ES"; recognizer.continuous=false; recognizer.interimResults=false;
    recognizer.onresult=e=>{
      const t=Array.from(e.results).map(r=>r[0].transcript).join(" ");
      q.value=(q.value? q.value+" " : "") + t;
    };
  }
  if(recognizer.listening){ recognizer.stop(); recognizer.listening=false; btnDict.textContent="üé§ Dictar"; }
  else { recognizer.start(); recognizer.listening=true; btnDict.textContent="‚èπ Detener dictado"; }
}

/* ====== Voz ====== */
const PREFERRED_NAMES=[
  "Microsoft Sabina","Microsoft Helena","Microsoft Laura","Microsoft Dalia","Microsoft Elvira","Microsoft Paloma","Microsoft Maria","Microsoft Lucia",
  "Google espa√±ol","Google espa√±ol de Estados","Google US Espa√±ol",
  "Monica","Paulina","Camila","Sofia","Elena","Isabella","Lucia","Maria","Carla",
  "Microsoft Jenny","Microsoft Aria","Microsoft Zira","Google US English"
];
const SP_LANGS=["es","es-ES","es-MX","es-US","es-419","es-AR","es-CL","es-CO","es-PE","es-EC"];
const EN_LANGS=["en","en-US","en-GB","en-CA","en-AU","en-IN"];
let selectedVoice=null; let langHint="es";
function pickVoice(lang){
  if(typeof speechSynthesis==="undefined") return null;
  const vs = speechSynthesis.getVoices()||[];
  const prefList = (lang==="en") ? ["Microsoft Jenny","Microsoft Aria","Microsoft Zira","Google US English"] : ["Microsoft Sabina","Microsoft Helena","Microsoft Laura","Microsoft Dalia","Microsoft Elvira","Microsoft Paloma","Microsoft Maria","Microsoft Lucia","Google espa√±ol","Google espa√±ol de Estados","Google US Espa√±ol","Monica","Paulina","Camila","Sofia","Elena","Isabella","Lucia","Maria","Carla"];
  const langList = (lang==="en") ? EN_LANGS : SP_LANGS;
  for(const name of prefList){ const m=vs.find(v=>v.name && v.name.toLowerCase().includes(name.toLowerCase())); if(m) return m; }
  const byLang = vs.find(v=>langList.some(l=>(v.lang||"").toLowerCase().startsWith(l.toLowerCase())));
  return byLang || vs[0] || null;
}
function initVoice(){ selectedVoice=pickVoice(langHint||"es"); }
if(typeof speechSynthesis!=="undefined"){ speechSynthesis.onvoiceschanged=()=>{ if(!selectedVoice){ initVoice(); } }; setTimeout(initVoice,150); }

const BULLET_RE = /^(?:[‚Ä¢\-‚Äì*]|\d+\.)\s+/u;
function generalToOrderedListHTML(g){
  if (!g) return "";
  const lines = g.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const bulletLike = lines.filter(s=>BULLET_RE.test(s)).length;
  const manyPlainLines = lines.filter(s=>!/[.!?;:]\s*$/.test(s) && s.length<=80).length;
  const shouldNumber = (lines.length>=3) && (bulletLike>0 || manyPlainLines >= Math.ceil(lines.length*0.6));
  if (shouldNumber) {
    const items = lines.map(s=>s.replace(BULLET_RE,"")).filter(Boolean);
    return `<ol>${items.map(it=>`<li>${esc(it)}</li>`).join("")}</ol>`;
  }
  return `<p>${esc(g).replace(/\n/g,"<br>")}</p>`;
}

/* ====== Linkificaci√≥n + verificaci√≥n ====== */
const URL_RE = /\bhttps?:\/\/[^\s<>"')]+/gi;
function linkifyHTML(html){
  return html.replace(URL_RE, (u)=>{
    const safe = esc(u);
    return `<a href="${safe}" target="_blank" rel="noopener noreferrer" data-pending-link="1">${safe}</a>`;
  });
}
async function verifyLinks(container, timeoutMs=3500){
  const anchors = Array.from(container.querySelectorAll('a[data-pending-link="1"]'));
  const checks = anchors.map(a=>{
    const url = a.getAttribute('href');
    return new Promise((resolve)=>{
      const ctl = new AbortController();
      const to = setTimeout(()=>{ ctl.abort(); resolve({a, ok:false}); }, timeoutMs);
      fetch(url, {method:"HEAD", mode:"no-cors", signal: ctl.signal})
        .then(()=>{ clearTimeout(to); resolve({a, ok:true}); })
        .catch(()=>{ clearTimeout(to); resolve({a, ok:false}); });
    });
  });
  const results = await Promise.all(checks);
  results.forEach(({a, ok})=>{
    if(!ok){
      // Omitir enlaces no disponibles
      a.replaceWith(document.createTextNode(a.getAttribute('href')));
    }else{
      a.removeAttribute('data-pending-link');
    }
  });
}

/* === TTS helpers === */
/* PATCH: TTS debe leer desde la primera palabra visible, SIN t√≠tulos ni thead */
function buildTTSTextFromOut(){
  const c=document.createElement("div"); 
  c.innerHTML = out.innerHTML;
  const parts=[];

  // Solo cuerpo: p√°rrafos, listas y filas de tablas (excluye h1..h6 y thead)
  c.querySelectorAll("p, ol, ul, table tbody").forEach(node=>{
    if(node.tagName==="P"){
      const t=node.textContent.trim();
      if(t) parts.push(t);
    }else if(node.tagName==="OL"||node.tagName==="UL"){
      const items=[...node.querySelectorAll("li")]
        .map((li,i)=>`${i+1}. ‚Äî ${li.textContent.trim()}`)
        .filter(Boolean);
      if(items.length) parts.push(items.join("\n\n"));
    }else if(node.tagName==="TBODY"){
      const rows=[...node.querySelectorAll("tr")];
      if(rows.length){
        const items=rows.map((tr,i)=>{
          const cells=[...tr.querySelectorAll("td")]
            .map(td=>td.textContent.trim());
          return `${i+1}. ‚Äî ${cells.join(" | ")}`;
        }).join("\n\n");
        if(items) parts.push(items);
      }
    }
  });

  return parts.join("\n\n");
}

/* FIN DE  TTS HELPERS */  
const TTS={
  enabled:false, chunks:[], i:0, utter:null, paused:false, speaking:false, textCache:"",
  makeChunks(text,maxLen=360){
    const blocks = String(text).split(/\n{2,}/); const res=[];
    for(const block of blocks){
      const parts=String(block).split(/(\.|\?|!|\n)/); let buf="";
      for(let i=0;i<parts.length;i+=2){
        const seg=(parts[i]||"")+(parts[i+1]||"");
        if((buf+seg).length<=maxLen) buf+=seg; else{ if(buf.trim()) res.push(buf.trim()); buf=seg; }
      }
      if(buf.trim()) res.push(buf.trim());
    }
    return res;
  },
  loadFromOut(){ this.textCache=buildTTSTextFromOut(); this.chunks=this.makeChunks(this.textCache); this.i=0; },
  speakNext(){
    if(!this.enabled || this.i>=this.chunks.length){ this.finish(); return; }
    const u=new SpeechSynthesisUtterance(this.chunks[this.i++]);
    if(selectedVoice) u.voice=selectedVoice;
    u.lang=(selectedVoice?.lang)||(langHint==="en"?"en-US":"es-ES");
    u.rate=0.98; u.pitch=1.08; u.volume=1;
    u.onstart=()=>{ this.speaking=true; this.paused=false; if(vid){ vid.loop=true; vid.play().catch(()=>{});} };
    u.onend =()=>{ this.speakNext(); };
    u.onerror=()=>{ this.speakNext(); };
    this.utter=u; speechSynthesis.speak(u);
  },
  start(fromIndex=0){
    if(typeof speechSynthesis==="undefined") return;
    if(!this.chunks.length) this.loadFromOut();
    this.enabled=true; if(fromIndex>=0) this.i=fromIndex;
    speechSynthesis.cancel(); this.speakNext();
  },
  pause(){ if(this.speaking && !this.paused){ speechSynthesis.pause(); this.paused=true; if(vid) vid.pause(); } },
  resume(){ if(this.paused){ speechSynthesis.resume(); this.paused=false; if(vid) vid.play().catch(()=>{}); }
           else if(!this.speaking && this.enabled){ this.speakNext(); } },
  restartFromStart(){ this.enabled=true; this.loadFromOut(); this.start(0); },
  finish(){ this.speaking=false; this.paused=false; this.utter=null; if(vid){ vid.loop=false; vid.pause(); } },
  stopAll(){ this.enabled=false; this.paused=false; this.speaking=false; this.utter=null; if(typeof speechSynthesis!=="undefined") speechSynthesis.cancel(); if(vid){ vid.loop=false; vid.pause(); } }
};

/* ====== Normalizar listas ====== */
function normalizeLists(lists){
  if(!Array.isArray(lists)) return [];
  return lists.map((entry,i)=>{
    if(Array.isArray(entry)){
      const flat=entry.every(x=>typeof x==="string"||typeof x==="number");
      return {title:`Lista ${i+1}`, items: flat? entry : entry.map(x=>Array.isArray(x)? x.join(" ") : String(x))};
    }else if(entry && typeof entry==="object"){
      return {title: entry.title||`Lista ${i+1}`, items: Array.isArray(entry.items)? entry.items: []};
    }else{
      return {title:`Lista ${i+1}`, items:[String(entry)]};
    }
  });
}

/* ====== Render ====== */
function renderAnswer(data, originalUserForMemory){
  // 1) limpiar descargos
  if (data && typeof data === "object"){
    if (typeof data.general === "string") data.general = stripDisclaimers(data.general);
    if (Array.isArray(data.lists)){
      data.lists = data.lists.map(x=>{
        if (Array.isArray(x)) return x.map(s=>typeof s==="string"? stripDisclaimers(s):s);
        if (x && typeof x==="object" && Array.isArray(x.items))
          x.items = x.items.map(s=>typeof s==="string"? stripDisclaimers(s):s);
        return x;
      });
    }
    if (Array.isArray(data.tables)){
      data.tables = data.tables.map(t=>{
        if (Array.isArray(t.columns)) t.columns = t.columns.map(c=>typeof c==="string"? stripDisclaimers(c):c);
        if (Array.isArray(t.rows)) t.rows = t.rows.map(r=> r.map(c=>typeof c==="string"? stripDisclaimers(c):c));
        return t;
      });
    }
  }

  let html="";
  const generalTxt = data.general || data.answer || data.text || "";
  if(generalTxt){ html += generalToOrderedListHTML(generalTxt); }

  const lists=normalizeLists(data.lists||[]);
  lists.forEach(l=>{
    html += `<h3>${esc(l.title||"Lista")}</h3><ol>` + l.items.map(it=>`<li>${esc(it)}</li>`).join("") + `</ol>`;
  });

  (data.tables||[]).forEach(t=>{
    const cols=t.columns||[]; const rows=t.rows||[];
    html += `<h3>${esc(t.title||"Tabla")}</h3><table><thead><tr>` + cols.map(c=>`<th>${esc(c)}</th>`).join("") + `</tr></thead><tbody>`;
    rows.forEach(r=>{ html += `<tr>` + r.map(x=>`<td>${esc(x)}</td>`).join("") + `</tr>`; });
    html += `</tbody></table>`;
  });

  // 2) linkificar (y luego verificar)
  html = linkifyHTML(html);
  out.innerHTML = html || "<em>Sin contenido.</em>";

  // 3) verificar enlaces y omitir no disponibles
  verifyLinks(out).catch(()=>{});

  // 4) memoria
  if (originalUserForMemory){
    const plainParts=[generalTxt].filter(Boolean);
    lists.forEach(l=>{ const block = l.items.map((it,i)=>`${i+1}. ${it}`).join("\n"); if(block) plainParts.push(block); });
    (data.tables||[]).forEach(t=>{
      const head=(t.columns||[]).join(" | ");
      const rows=(t.rows||[]).map(r=>r.join(" | ")).join("\n");
      const tbl=[head,rows].filter(Boolean).join("\n"); if(tbl) plainParts.push(tbl);
    });
    const answerPlain = plainParts.join("\n\n").trim() || "[respuesta]";
    historyTurns.push({ role:"assistant", content: answerPlain });
    sessionStorage.setItem(HS_KEY, JSON.stringify(historyTurns.slice(-20)));
  }

  // 5) Narraci√≥n + video
  TTS.enabled = true; TTS.loadFromOut(); TTS.start(0);
}

/* ====== Compactador ====== */
function summarizeHistoryCompact(h, maxTurns=6){
  const tail = h.slice(-maxTurns);
  return tail.map((t,i)=>{
    const r = t.role === "user" ? "Q" : "R";
    const txt = String(t.content||"").replace(/\s+/g," ").trim().slice(0, 500);
    return `${r}${i+1}: ${txt}`;
  }).join("\n");
}

/* ====== Detecci√≥n de idioma fuerte ====== */
function detectLangStrong(text){
  const t=(text||"").toLowerCase();
  const enHits=(t.match(/\b(the|and|you|your|please|could|would|with|from|to|of|in|on|are|is|can|help|explain|summary|benefits|analysis|report|for|about)\b/g)||[]).length;
  const esHits=(t.match(/\b(el|la|de|y|que|para|con|desde|a|en|son|es|por favor|podr√≠a|ser√≠a|ayuda|explica|resumen|beneficios|informe|sobre)\b/g)||[]).length;
  if(enHits>esHits) return "en";
  if(esHits>enHits) return "es";
  const nonASCII=(t.match(/[√°√©√≠√≥√∫√±√º]/g)||[]).length;
  return nonASCII>0 ? "es":"en";
}

/* ====== Backend (memoria, cancelaci√≥n, forzar idioma) ====== */
async function ask(){
  if(isBusy) return;
  const text=q.value.trim(); if(!text) return;

  // detectar idioma ‚Üí forzar respuesta SOLO en ese idioma
  langHint = detectLangStrong(text);
  selectedVoice = pickVoice(langHint);

  isBusy = true;
  btnSend.disabled = true;
  btnCancel.disabled = false;
  const old=btnSend.textContent; btnSend.textContent="Enviando‚Ä¶";
  setStatusLoading(langHint==="en" ? "Processing‚Ä¶" : "Consultando‚Ä¶");

  // memoria: turno del usuario (provisional)
  historyTurns.push({ role:"user", content: text });
  sessionStorage.setItem(HS_KEY, JSON.stringify(historyTurns.slice(-20)));

  // contexto compacto
  const compact = summarizeHistoryCompact(historyTurns.slice(0,-1), 6);
  const recentRaw = historyTurns.slice(-3, -1)
    .map(t => `${t.role === "user" ? (langHint==="en"?"Last user:":"Usuario:") : (langHint==="en"?"Last reply:":"Respuesta:")} ${t.content.slice(0,1200)}`)
    .join("\n");

  const forceHint = langHint==="en"
    ? "Answer strictly in English. Do not include Spanish words."
    : "Responde estrictamente en espa√±ol. No incluyas palabras en ingl√©s.";

  const langBanner = langHint==="en"
    ? "[LANG:EN]\nYou must answer ONLY in English.\n"
    : "[LANG:ES]\nDebes responder SOLO en espa√±ol.\n";

  const prompt = [
    langBanner,
    compact ? (langHint==="en" ? `PREVIOUS CONVERSATION (brief):\n${compact}` : `CONVERSACI√ìN ANTERIOR (breve):\n${compact}`) : "",
    recentRaw ? (langHint==="en" ? `RECENT CONTEXT (raw):\n${recentRaw}` : `CONTEXTO RECIENTE (crudo):\n${recentRaw}`) : "",
    forceHint,
    langHint==="en" ? `CURRENT QUESTION:\n${text}` : `PREGUNTA ACTUAL:\n${text}`
  ].filter(Boolean).join("\n\n");

  // controlador para cancelar
  inFlightController = new AbortController();

  const headers = {
    "Content-Type":"application/json",
    "Accept":"application/json",
    "Accept-Language": langHint==="en" ? "en-US,en;q=0.9" : "es-ES,es;q=0.9",
    "X-Force-Language": langHint,
    "Prefer": `respond-language=${langHint}`
  };

  try{
    let r = await fetch(`${API_BASE}${GPT_PATH}`, {
      method:"POST",
      headers,
      body: JSON.stringify({ q: prompt, force_lang:true, system_hint: forceHint }),
      signal: inFlightController.signal
    });
    if(r.status===404 || r.status===405){
      r = await fetch(`${API_BASE}${FALLBACK_PATH}?q=${encodeURIComponent(prompt)}`, {
        headers:{ "Accept":"application/json" },
        signal: inFlightController.signal
      });
    }
    const data = await r.json().catch(()=>({}));
    if(!r.ok || data.ok===false) throw new Error(data.error || data.general || `HTTP ${r.status}`);

    renderAnswer(data, /*for memory*/ text);
    saveSession(text, data);
  }catch(e){
    if (e.name === "AbortError"){
      out.innerHTML = `<pre style="color:#b45309">Consulta cancelada.</pre>`;
    } else {
      out.innerHTML = `<pre style="color:var(--err)">${String(e)}</pre>`;
      historyTurns.pop();
      sessionStorage.setItem(HS_KEY, JSON.stringify(historyTurns.slice(-20)));
    }
  }finally{
    isBusy=false;
    btnSend.disabled=false; btnSend.textContent=old; btnCancel.disabled=true;
    clearStatus();
    inFlightController = null;
  }
}

/* ====== Cancelar ====== */
btnCancel.addEventListener("click", ()=>{
  if(inFlightController){ try{ inFlightController.abort(); }catch{} }
  TTS.stopAll();
  clearStatus();
  btnCancel.disabled = true;
});

/* ====== Exportar (pantalla principal) ====== */
function printHTML(html){
  const iframe=document.createElement('iframe');
  iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
  iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
  document.body.appendChild(iframe);
  const doc=iframe.contentWindow||iframe.contentDocument;
  const idoc=doc.document||doc;
  idoc.open(); idoc.write(html); idoc.close();
  setTimeout(()=>{ try{ (iframe.contentWindow||iframe).focus(); (iframe.contentWindow||iframe).print(); }catch{} }, 60);
  setTimeout(()=>{ try{ document.body.removeChild(iframe); }catch{} }, 30000);
}

function buildPdfHTMLFromContainer(containerHTML, questionText, opts){
  // calcular columnas m√°ximas
  const tmp = document.createElement('div');
  tmp.innerHTML = containerHTML;
  const tables = Array.from(tmp.querySelectorAll('table'));
  const maxCols = tables.reduce((mx,t)=>{
    const headCount = t.querySelectorAll('thead th').length;
    const bodyFirst = t.querySelector('tbody tr');
    const bodyCount = bodyFirst ? bodyFirst.querySelectorAll('td').length : 0;
    return Math.max(mx, headCount || bodyCount);
  }, 0);

  // Heur√≠stica: A4 landscape para ‚â•7, A3 landscape para ‚â•12
  const useA3 = maxCols >= 12;
  const useLandscape = maxCols >= 7;
  // Escala tipograf√≠a
  let baseFont = 16, cellFont = 16;
  if (maxCols >= 10){ baseFont = 14; cellFont = 13; }
  if (maxCols >= 12){ baseFont = 13; cellFont = 12; }
  if (maxCols >= 14){ baseFont = 12; cellFont = 11; }

  const pageCSS = useLandscape 
    ? `@page{ size: ${useA3? 'A3' : 'A4'} landscape; margin: 12mm; }`
    : `@page{ size: A4 portrait; margin: 14mm; }`;

  const baseCSS = `
    body{font:${baseFont}px/1.5 system-ui;margin:0;color:#111}
    h3{margin:0 0 8px 0}
    table{border-collapse:collapse;width:100%; table-layout:auto}
    td,th{border:1px solid #ddd;padding:6px; font-size:${cellFont}px; word-break:break-word}
    thead th{background:#f8fafc;text-align:left}
    table, tr, td, th{ page-break-inside: avoid; }
  `;

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Lexium - Export PDF</title>
    <style>${pageCSS} ${baseCSS}</style>
    </head><body>
    ${questionText ? `<h3>Pregunta</h3><p>${esc(questionText)}</p>` : ""}
    ${containerHTML}
    </body></html>`;
  return html;
}

selExport.addEventListener("change", ()=>{
  const v=selExport.value; selExport.value="";
  if(!out.innerHTML.trim()){ alert("No hay contenido que exportar."); return; }
  const questionText=(q.value||"").trim();

  if(v==="pdf"){
    const html = buildPdfHTMLFromContainer(out.innerHTML, questionText, {});
    try{ printHTML(html); }catch(_){}
    return;
  }

  if(v==="csv"){
    let rows=[];
    if(questionText){ rows.push(["PREGUNTA", questionText]); }
    out.querySelectorAll("p").forEach(p=>{ const t=p.textContent.trim(); if(t) rows.push(["TEXTO", t]); });
    out.querySelectorAll("ol,ul").forEach(list=>{
      const items=[...list.querySelectorAll("li")].map((li,i)=>`${i+1}. ${li.textContent.trim()}`);
      if(items.length){ rows.push(["LISTA", items.join(" \\ ")]); }
    });
    out.querySelectorAll("table").forEach(tbl=>{
      const head=[...tbl.querySelectorAll("thead th")].map(th=>th.textContent.trim());
      if(head.length) rows.push(["TABLA CABECERAS", ...head]);
      const trs=[...tbl.querySelectorAll("tbody tr")];
      trs.forEach((tr,ri)=>{ const cells=[...tr.querySelectorAll("td")].map(td=>td.textContent.trim()); rows.push([`FILA ${ri+1}`, ...cells]); });
    });
    const csv = rows.map(r => r.map(cell=>{
      const v=String(cell??"");
      if (/[",\n]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
      return v;
    }).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="export.csv"; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),500);
    return;
  }

  if(v==="doc"){
    const html = `<!doctype html><html><head><meta charset="utf-8"></head><body>
      ${questionText ? `<h3>Pregunta</h3><p>${esc(questionText)}</p>` : ""}
      ${out.innerHTML}
    </body></html>`;
    const blob=new Blob([html],{type:"application/msword"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="export.doc"; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),500);
  }
});

/* ====== Exportar (dentro de ‚ÄúVer‚Äù del historial) ====== */
function histExport(kind){
  const contentHTML = histContent.innerHTML || "";
  const title = (histQuestion.textContent||"").trim();

  if(kind==="pdf"){
    const html = buildPdfHTMLFromContainer(contentHTML, title, {});
    try{ printHTML(html); }catch(_){}
    return;
  }
  if(kind==="csv"){
    const wrapper = document.createElement('div');
    wrapper.innerHTML = contentHTML;
    let rows=[];
    if(title){ rows.push(["PREGUNTA", title]); }
    wrapper.querySelectorAll("p").forEach(p=>{ const t=p.textContent.trim(); if(t) rows.push(["TEXTO", t]); });
    wrapper.querySelectorAll("ol,ul").forEach(list=>{
      const items=[...list.querySelectorAll("li")].map((li,i)=>`${i+1}. ${li.textContent.trim()}`);
      if(items.length){ rows.push(["LISTA", items.join(" \\ ")]); }
    });
    wrapper.querySelectorAll("table").forEach(tbl=>{
      const head=[...tbl.querySelectorAll("thead th")].map(th=>th.textContent.trim());
      if(head.length) rows.push(["TABLA CABECERAS", ...head]);
      const trs=[...tbl.querySelectorAll("tbody tr")];
      trs.forEach((tr,ri)=>{ const cells=[...tr.querySelectorAll("td")].map(td=>td.textContent.trim()); rows.push([`FILA ${ri+1}`, ...cells]); });
    });
    const csv = rows.map(r => r.map(cell=>{
      const v=String(cell??"");
      if (/[",\n]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
      return v;
    }).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="historial.csv"; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),500);
    return;
  }
  if(kind==="doc"){
    const html = `<!doctype html><html><head><meta charset="utf-8"></head><body>
      ${title ? `<h3>Pregunta</h3><p>${esc(title)}</p>` : ""}
      ${contentHTML}
    </body></html>`;
    const blob=new Blob([html],{type:"application/msword"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="historial.doc"; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),500);
    return;
  }
}
histPdfBtn.addEventListener("click", ()=>histExport("pdf"));
histCsvBtn.addEventListener("click", ()=>histExport("csv"));
histDocBtn.addEventListener("click", ()=>histExport("doc"));

/* ====== Botones ====== */
btnSend.addEventListener("click", ask);
btnDict.addEventListener("click", toggleDict);
btnToggleAV.addEventListener("click", ()=>{
  if(!TTS.enabled){ TTS.enabled=true; TTS.loadFromOut(); TTS.start(TTS.i); btnToggleAV.textContent="‚è∏ Silenciar voz"; return; }
  if(TTS.paused){ TTS.resume(); btnToggleAV.textContent="‚è∏ Silenciar voz"; }
  else if(TTS.speaking){ TTS.pause(); btnToggleAV.textContent="‚ñ∂ Reanudar voz"; }
  else { TTS.resume(); btnToggleAV.textContent="‚è∏ Silenciar voz"; }
});
btnReplay.addEventListener("click", ()=>{ TTS.restartFromStart(); btnToggleAV.textContent="‚è∏ Silenciar voz"; });
btnClear.addEventListener("click", ()=>{ q.value=""; out.innerHTML=""; clearStatus(); TTS.stopAll(); });
btnNew.addEventListener("click", ()=>{
  saveSession(q.value.trim()||"(sin pregunta)", {});
  TTS.stopAll(); q.value=""; out.innerHTML=""; clearStatus();
  historyTurns = []; sessionStorage.removeItem(HS_KEY);
});

/* ====== UX ====== */
q.addEventListener("keydown",(e)=>{ if((e.ctrlKey||e.metaKey) && e.key==="Enter") ask(); });
q.addEventListener("input", ()=>{ /* altura fija 2 l√≠neas */ });

/* Captura errores JS */
window.addEventListener("error",()=>{ clearStatus(); },{once:false});
</script>
</body>
</html>

